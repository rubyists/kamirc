#!/usr/bin/env ruby

require_relative '../lib/kamirc'

require_relative '../lib/kamirc/handler/insult'
require_relative '../lib/kamirc/handler/pong'
require_relative '../lib/kamirc/handler/join'
require_relative '../lib/kamirc/handler/google'

options = KamIRC::Options.new(:kamirc)

options.dsl do
  o "Host or IP to connect to",
    :host, "chat.freenode.net"

  o "Port to connect to",
    :port, 6667

  o "Password the bot uses to authenticate to services",
    :pass, nil

  o "Nickname",
    :nick, "manverbot"

  o "Username",
    :user, "Manveru's Bot"

  sub :google_search do
    o "Your google custom search API key",
      :key, nil

    o "The custom search engine ID to scope this search query (cx)",
      :cx, nil
  end
end

begin
  File.open(File.expand_path("~/.netrc")) do |io|
    io.each_line do |line|
      if /^machine\s+www\.googleapis\.com\s+login\s+(?<cx>\S+)\s+password\s+(?<key>\S+)/ =~ line
        options.google_search.key ||= key
        options.google_search.cx ||= cx
      end
    end
  end
rescue Errno::ENOENT
end

EM.run do
  KamIRC::Bot.connect options do |bot|
    bot.add(KamIRC::Pong, KamIRC::Insult, KamIRC::Join, KamIRC::Google)
  end
end
